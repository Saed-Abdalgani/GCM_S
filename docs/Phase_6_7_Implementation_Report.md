# Phase 6 & 7 Implementation Report

## Introduction
This document details the implementation of **Phase 6 (Customer Info)** and **Phase 7 (Subscription Expiry Notifications)** for the GCM system. These features providing customers with profile management capabilities and proactive system notifications for subscription management.

---

## Phase 6: Customer Info Implementation

### Goal
To allow customers to view and update their personal profiles, view their purchase history, and allow managers to oversee customer activities.

### 1. Database & Domain Models (DTOs)
New Data Transfer Objects were created to structure the data flow between server and client:
- **`CustomerProfileDTO`**: Encapsulates user profile data (username, email, phone, masked card info) and statistics (total spent, member since).
- **`CustomerPurchaseDTO`**: Detailed record of a purchase, including factory methods for `oneTime` and `subscription` types. It calculates active status dynamically.
- **`CustomerListItemDTO`**: Lightweight summary object for the Admin/Manager list view.

### 2. Server-Side Logic
**`CustomerHandler`** was implemented to handle the following requests:
- `GET_MY_PROFILE`: Retrieves the authenticated user's profile.
- `UPDATE_MY_PROFILE`: Allows updating email and phone number.
- `ADMIN_LIST_CUSTOMERS`: (Manager only) Lists all customers with summary stats.
- `ADMIN_GET_CUSTOMER_PURCHASES`: (Manager only) Drills down into a specific customer's history.

**DAO Extensions:**
- **`UserDAO`**: Added methods `getProfile`, `updateProfile`, and `listAllCustomers`.
- **`PurchaseDAO`**: Added `getPurchasesDetailed` to fetch comprehensive history including subscription expiry dates/status.

### 3. Client-Side Interface
Two new screens were developed:
- **Profile Screen (`profile.fxml`)**:
  - Displays user stats (Total Purchases, Total Spent).
  - Editable form for Email and Phone.
  - Table view of all purchases with a "Download" action for active maps.
- **Admin Customers Screen (`admin_customers.fxml`)**:
  - Dashboard for managers to search and view all customers.
  - Shows aggregate metrics (Total Revenue, Avg Spend).
  - Drill-down panel to inspect specific customer purchases.

---

## Phase 7: Subscription Expiry Notifications Implementation

### Goal
To proactively notify users when their subscriptions are about to expire (3 days prior) across multiple channels (In-App, Email, SMS).

### 1. Database Changes
A new table `subscription_reminders` was introduced to handle **deduplication**.
- Ensures users don't receive multiple notifications for the same event.
- Tracks `subscription_id` and `reminder_type` (e.g., '3_DAYS').

### 2. Background Scheduler (`SubscriptionScheduler`)
A standalone background thread that runs on the server (configured to run every 2 minutes for demonstration purposes).
- **Logic**:
  1. Queries `subscriptions` table for items expiring in ≤ 3 days.
  2. Checks `subscription_reminders` to see if a notification was already sent.
  3. If not sent:
     - Creates an **In-App Notification** via `NotificationDAO`.
     - Simulates sending an **Email** (logged to console).
     - Simulates sending an **SMS** (logged to console).
     - Records the event in `subscription_reminders`.

### 3. Notification System
- **`NotificationHandler`**: Handles fetching notifications and marking them as read.
- **Dashboard Integration**: A **Bell Icon** was added to the Dashboard header.
  - It polls for unread notifications on load.
  - Displays a red badge with the count (e.g., "3").
  - Clicking it opens a dialog showing recent alerts.

---

## Summary of Architecture
The implementation follows the project's layered architecture:
- **Boundary (Client)**: FXML & Controllers (`ProfileScreen`, `AdminCustomersScreen`) handle UI and user input.
- **Control (Client)**: `GCMClient` singleton manages the connection and request dispatching.
- **Handler (Server)**: `CustomerHandler` and `NotificationHandler` process specific business logic.
- **DAO (Server)**: `UserDAO`, `PurchaseDAO`, `NotificationDAO` abstract the database interactions.
- **Scheduler (Server)**: `SubscriptionScheduler` handles asynchronous background tasks.

## Role-Based Access Control (RBAC)
Strict access control was implemented:
| Feature | Customer | Employee | Manager |
|:---|:---:|:---:|:---:|
| **View Own Profile** | ✅ | ✅ | ✅ |
| **Edit Own Profile** | ✅ | ✅ | ✅ |
| **View Own Purchases** | ✅ | ✅ | ✅ |
| **Manage Customers** | ❌ | ❌ | ✅ |
| **View Notifications** | ✅ | ✅ | ✅ |

---
*Report generated by Antigravity Agent on 2026-01-08*
